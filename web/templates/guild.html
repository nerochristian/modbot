<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{guild_name}} - ModBot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/panel-theme.css">
</head>

<body class="has-sidebar">
        <!-- Top Navbar -->
    <nav class="topbar sapphire-topbar">
        <div class="topbar-left">
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">&#9776;</button>
            <div class="sapphire-brand">
                <div class="logo-icon">MB</div>
                <span class="logo-text">Sapphire</span>
                <span class="server-chip">text</span>
            </div>
        </div>
        <div class="topbar-right">
            <a href="/dashboard" class="btn btn-ghost btn-sm">Servers</a>
            <div class="sapphire-user">
                <img src="{{user_avatar}}" alt="{{user_name}}" class="topbar-guild-icon">
                <span>{{user_name}}</span>
            </div>
            <a href="/logout" class="btn btn-ghost btn-sm">Logout</a>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar sapphire-sidebar" id="sidebar">
        <div class="sidebar-controls">
            <a href="/dashboard" class="mini-action icon-only" title="Back to servers">Home</a>
            <button class="mini-action fetch-action" onclick="init()">Fetch roles/channels</button>
        </div>

        <div class="changelog-card">
            <div class="changelog-head">
                <span>CHANGELOG 09/24</span>
                <button type="button" aria-label="Dismiss" class="changelog-close">&times;</button>
            </div>
            <h4><span class="badge-new">NEW</span> JoinGuard &amp; Randomized Welcome Messages</h4>
            <p>You can now automatically take actions against suspicious users and send welcome messages randomly.</p>
            <button class="changelog-link">View changelog</button>
        </div>

        <div class="sidebar-header">
            <img src="{{guild_icon}}" alt="" class="sidebar-guild-icon">
            <div class="sidebar-guild-info">
                <h3>{{guild_name}}</h3>
                <span>{{member_count}} members</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a class="nav-item" data-section="bot-settings" onclick="switchSection('bot-settings')">
                <span class="nav-icon">&#9881;</span> General Settings
            </a>
            <a class="nav-item" data-section="automod" onclick="switchSection('automod')">
                <span class="nav-icon">AM</span> Auto Moderation <span class="item-pill">NEW</span>
            </a>
            <a class="nav-item active" data-section="moderation" onclick="switchSection('moderation')">
                <span class="nav-icon">MOD</span> Moderation
            </a>
            <a class="nav-item" data-section="logging" onclick="switchSection('logging')">
                <span class="nav-icon">LOG</span> Logging
            </a>
            <a class="nav-item" data-section="roles" onclick="switchSection('roles')">
                <span class="nav-icon">ROL</span> Immune Roles
            </a>
            <div class="nav-divider"></div>
            <span class="nav-label">FEATURES</span>
            <a class="nav-item" data-section="voice" onclick="switchSection('voice')">
                <span class="nav-icon">VOC</span> Voice
            </a>
            <a class="nav-item" data-section="tickets" onclick="switchSection('tickets')">
                <span class="nav-icon">TKT</span> Tickets
            </a>
            <a class="nav-item" data-section="antiraid" onclick="switchSection('antiraid')">
                <span class="nav-icon">ARD</span> Anti-Raid
            </a>
            <a class="nav-item" data-section="verification" onclick="switchSection('verification')">
                <span class="nav-icon">VER</span> Verification
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content panel-shell" id="mainContent">
        <!-- Toast -->
        <div class="toast" id="toast"></div>

        <!-- BOT SETTINGS -->
        <section class="content-section" id="sec-bot-settings">
            <div class="section-title-bar">
                <h1>Bot Settings</h1>
                <span class="section-badge">General</span>
            </div>
            <div class="panel-row">
                <div class="panel glass">
                    <h2>Bot Info</h2>
                    <div class="info-row"><span class="info-label">Nickname</span><span class="info-value"
                            id="botNickname">{{bot_nickname}}</span></div>
                    <div class="input-group" style="margin-top:1rem">
                        <label>Custom Prefix</label>
                        <div class="list-input-row">
                            <input type="text" data-key="prefix" maxlength="5" class="input-field" placeholder=","
                                id="prefixInput">
                            <button class="btn btn-primary btn-sm" onclick="saveAll()">Apply</button>
                        </div>
                    </div>
                </div>
                <div class="panel glass">
                    <h2>Recent Actions</h2>
                    <div class="actions-table-wrap">
                        <table class="data-table" id="actionsTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="actionsBody">
                                <tr>
                                    <td colspan="3" class="empty-row">No actions yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- AUTOMOD -->
        <section class="content-section" id="sec-automod">
            <div class="section-title-bar">
                <h1>AutoMod</h1>
                <span class="section-badge">Filters</span>
            </div>
            <div class="filter-grid" id="filterGrid">
                <!-- JS will generate filter cards -->
            </div>
            <div class="panel glass" style="margin-top:1.5rem">
                <h2>Bad Words <span class="list-count" id="badwordCount">0</span></h2>
                <div class="list-input-row">
                    <input type="text" placeholder="Add words (comma-separated)" id="badwordInput" class="input-field">
                    <button class="btn btn-primary btn-sm" onclick="addToList('badwords')">Add</button>
                </div>
                <div class="tag-list" id="badwordTags"></div>
            </div>
            <div class="panel glass" style="margin-top:1rem">
                <h2>Whitelisted Domains <span class="list-count" id="domainCount">0</span></h2>
                <div class="list-input-row">
                    <input type="text" placeholder="Add domains (comma-separated)" id="domainInput" class="input-field">
                    <button class="btn btn-primary btn-sm" onclick="addToList('domains')">Add</button>
                </div>
                <div class="tag-list" id="domainTags"></div>
            </div>
        </section>

        <!-- LOGGING -->
        <section class="content-section" id="sec-logging">
            <div class="section-title-bar">
                <h1>Logging</h1>
                <span class="section-badge">Channels</span>
            </div>
            <p class="section-desc">Configure which channels receive different types of log messages.</p>
            <div class="logging-grid">
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">MOD</span>
                        <h3>Mod Log</h3>
                    </div>
                    <p>Ban, kick, mute, warn actions</p>
                    <select data-key="log_channel_mod" class="input-field log-select"></select>
                </div>
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">AUD</span>
                        <h3>Audit Log</h3>
                    </div>
                    <p>Channel, role, server changes</p>
                    <select data-key="log_channel_audit" class="input-field log-select"></select>
                </div>
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">MSG</span>
                        <h3>Message Log</h3>
                    </div>
                    <p>Edits, deletes, bulk deletes</p>
                    <select data-key="log_channel_message" class="input-field log-select"></select>
                </div>
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">VOC</span>
                        <h3>Voice Log</h3>
                    </div>
                    <p>Join, leave, move, mute events</p>
                    <select data-key="log_channel_voice" class="input-field log-select"></select>
                </div>
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">AMD</span>
                        <h3>AutoMod Log</h3>
                    </div>
                    <p>Filter triggers and actions</p>
                    <select data-key="log_channel_automod" class="input-field log-select"></select>
                </div>
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">RPT</span>
                        <h3>Report Log</h3>
                    </div>
                    <p>User reports</p>
                    <select data-key="log_channel_report" class="input-field log-select"></select>
                </div>
                <div class="log-card glass">
                    <div class="log-card-header"><span class="log-icon">TKT</span>
                        <h3>Ticket Log</h3>
                    </div>
                    <p>Ticket open/close/claim</p>
                    <select data-key="log_channel_ticket" class="input-field log-select"></select>
                </div>
            </div>
        </section>

        <!-- MODERATION -->
        <section class="content-section active" id="sec-moderation">
            <div class="section-title-bar sapphire-title">
                <h1>Moderation</h1>
                <span class="section-badge">Panel</span>
            </div>
            <p class="section-desc sapphire-desc">Manage cases, reports, punishment defaults, and moderation automation.</p>

            <div class="mod-top-grid">
                <article class="mod-feature-card glass">
                    <div class="mod-feature-icon">CA</div>
                    <div>
                        <h3>Cases</h3>
                        <p>Manage all ban, kick, mute and warn cases.</p>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('casesPanel').scrollIntoView({behavior:'smooth'})">View cases</button>
                </article>
                <article class="mod-feature-card glass">
                    <div class="mod-feature-icon">RP</div>
                    <div>
                        <h3>User reports</h3>
                        <p>Update this server's user report configuration.</p>
                    </div>
                    <button class="btn btn-primary btn-sm">Set up</button>
                </article>
            </div>

            <div class="feature-rows">
                <div class="feature-row glass">
                    <div>
                        <h3>Appeals</h3>
                        <p>Create custom forms for users to appeal punishments.</p>
                    </div>
                    <button class="row-arrow" type="button" onclick="openAppealsModal()">&rsaquo;</button>
                </div>
                <div class="feature-row glass">
                    <div>
                        <h3>Message histories</h3>
                        <p>View and share generated message histories of users.</p>
                    </div>
                    <button class="row-arrow" type="button">&rsaquo;</button>
                </div>
                <div class="feature-row glass">
                    <div>
                        <h3>Punish settings</h3>
                        <p>Edit default ban, kick, mute and warn actions.</p>
                    </div>
                    <button class="row-arrow" type="button" onclick="document.getElementById('warningThresholds').scrollIntoView({behavior:'smooth'})">&rsaquo;</button>
                </div>
                <div class="feature-row glass">
                    <div>
                        <h3>Immune roles</h3>
                        <p>Set roles that are immune to moderation actions.</p>
                    </div>
                    <button class="row-arrow" type="button" onclick="switchSection('roles')">&rsaquo;</button>
                </div>
                <div class="feature-row feature-row-toggle glass">
                    <div>
                        <h3>User notifications</h3>
                        <p>Toggle direct messages for punishments.</p>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" data-key="automod_notify_users">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="stats-row" id="statsRow">
                <div class="stat-card glass">
                    <span class="stat-number" id="statCases">0</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="stat-card glass">
                    <span class="stat-number" id="statWarnings">0</span>
                    <span class="stat-label">Warnings</span>
                </div>
                <div class="stat-card glass">
                    <span class="stat-number" id="statReports">0</span>
                    <span class="stat-label">Reports</span>
                </div>
                <div class="stat-card glass">
                    <span class="stat-number" id="statTickets">0</span>
                    <span class="stat-label">Tickets</span>
                </div>
            </div>

            <div class="panel glass" id="casesPanel" style="margin-top:1.5rem">
                <h2>Recent Cases</h2>
                <div class="actions-table-wrap">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>Moderator</th>
                                <th>Reason</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="casesBody">
                            <tr>
                                <td colspan="6" class="empty-row">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel glass" id="warningThresholds" style="margin-top:1.5rem">
                <h2>Warning Thresholds</h2>
                <p class="section-desc">Automatically punish users when they reach warning limits from manual warns and AutoMod.</p>
                <div class="settings-grid cols-2">
                    <div class="setting-card">
                        <div class="setting-header">
                            <span class="setting-icon">TH</span>
                            <div>
                                <h3>Enable Thresholds</h3>
                                <p>Auto-punish at X warnings</p>
                            </div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" data-key="warn_thresholds_enabled" id="toggle_warn_thresholds">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label>Mute at <span class="hint">(warnings)</span></label>
                        <input type="number" data-key="warn_threshold_mute" min="1" max="50" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Kick at <span class="hint">(warnings)</span></label>
                        <input type="number" data-key="warn_threshold_kick" min="1" max="50" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Ban at <span class="hint">(warnings)</span></label>
                        <input type="number" data-key="warn_threshold_ban" min="1" max="50" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Mute Duration <span class="hint">(seconds)</span></label>
                        <input type="number" data-key="warn_mute_duration" min="60" max="604800" class="input-field">
                    </div>
                </div>
            </div>
        </section>

        <!-- ROLES -->
        <section class="content-section" id="sec-roles">
            <div class="section-title-bar">
                <h1>Roles</h1>
                <span class="section-badge">Configuration</span>
            </div>
            <p class="section-desc">Assign special roles used by the bot's features.</p>
            <div class="roles-grid">
                <div class="role-card glass">
                    <div class="role-header"><span>MR</span>
                        <h3>Mute Role</h3>
                    </div>
                    <p>Applied to muted users</p>
                    <select data-key="mute_role" class="input-field role-select" id="muteRoleSelect"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>BP</span>
                        <h3>Bypass Role</h3>
                    </div>
                    <p>Bypasses all AutoMod filters</p>
                    <select data-key="automod_bypass_role_id" class="input-field role-select"
                        id="bypassRoleSelect"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>QR</span>
                        <h3>Quarantine Role</h3>
                    </div>
                    <p>Restricts suspicious users</p>
                    <select data-key="automod_quarantine_role_id" class="input-field role-select"
                        id="quarantineRoleSelect"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>MG</span>
                        <h3>Manager Role</h3>
                    </div>
                    <p>Can configure bot settings</p>
                    <select data-key="manager_role" class="input-field role-select" id="managerRoleSelect"></select>
                </div>
            </div>
            <h2 style="margin-top:1.5rem">Hierarchy Roles</h2>
            <p class="section-desc">Define your server's staff hierarchy. These roles determine command permissions.</p>
            <div class="roles-grid">
                <div class="role-card glass">
                    <div class="role-header"><span>OW</span>
                        <h3>Owner Role</h3>
                    </div>
                    <p>Full access to all commands</p>
                    <select data-key="owner_role" class="input-field role-select"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>AD</span>
                        <h3>Admin Role</h3>
                    </div>
                    <p>Manage settings and moderation</p>
                    <select data-key="admin_role" class="input-field role-select"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>MD</span>
                        <h3>Moderator Role</h3>
                    </div>
                    <p>Moderation commands access</p>
                    <select data-key="moderator_role" class="input-field role-select"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>HP</span>
                        <h3>Helper Role</h3>
                    </div>
                    <p>Limited moderation access</p>
                    <select data-key="helper_role" class="input-field role-select"></select>
                </div>
                <div class="role-card glass">
                    <div class="role-header"><span>WL</span>
                        <h3>Whitelisted Role</h3>
                    </div>
                    <p>Bypasses certain restrictions</p>
                    <select data-key="whitelisted_role" class="input-field role-select"></select>
                </div>
            </div>
        </section>

        <!-- VOICE -->
        <section class="content-section" id="sec-voice">
            <div class="section-title-bar">
                <h1>Voice</h1>
                <span class="section-badge">Settings</span>
            </div>
            <div class="settings-grid cols-2">
                <div class="setting-card">
                    <div class="setting-header">
                        <span class="setting-icon">AFK</span>
                        <div>
                            <h3>AFK Detection</h3>
                            <p>Auto-detect inactive voice users</p>
                        </div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" data-key="voice_afk_detection" id="toggle_afk">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="input-group">
                    <label>AFK Timeout <span class="hint">(minutes)</span></label>
                    <input type="number" data-key="voice_afk_timeout" min="1" max="120" class="input-field">
                </div>
                <div class="input-group">
                    <label>Response Timeout <span class="hint">(seconds)</span></label>
                    <input type="number" data-key="afk_response_timeout" min="10" max="120" class="input-field">
                </div>
            </div>
        </section>

        <!-- TICKETS -->
        <section class="content-section" id="sec-tickets">
            <div class="section-title-bar">
                <h1>Tickets</h1>
                <span class="section-badge">Support</span>
            </div>
            <div class="settings-grid cols-2">
                <div class="input-group">
                    <label>Support Role</label>
                    <select data-key="ticket_support_role" class="input-field role-select"
                        id="ticketSupportRoleSelect"></select>
                </div>
                <div class="input-group">
                    <label>Ticket Log Channel</label>
                    <select data-key="ticket_log_channel" class="input-field log-select"
                        id="ticketLogChannelSelect"></select>
                </div>
            </div>
        </section>

        <!-- ANTI-RAID -->
        <section class="content-section" id="sec-antiraid">
            <div class="section-title-bar">
                <h1>Anti-Raid</h1>
                <span class="section-badge">Protection</span>
            </div>
            <div class="settings-grid cols-2">
                <div class="setting-card">
                    <div class="setting-header">
                        <span class="setting-icon">AR</span>
                        <div>
                            <h3>Anti-Raid</h3>
                            <p>Detect mass join raids</p>
                        </div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" data-key="antiraid_enabled" id="toggle_antiraid">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="input-group">
                    <label>Join Threshold <span class="hint">(users)</span></label>
                    <input type="number" data-key="antiraid_join_threshold" min="2" max="50" class="input-field">
                </div>
                <div class="input-group">
                    <label>Time Window <span class="hint">(seconds)</span></label>
                    <input type="number" data-key="antiraid_join_interval" min="5" max="120" class="input-field">
                </div>
                <div class="input-group">
                    <label>Action</label>
                    <select data-key="antiraid_action" class="input-field">
                        <option value="kick">Kick</option>
                        <option value="ban">Ban</option>
                        <option value="lockdown">Lockdown</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- VERIFICATION -->
        <section class="content-section" id="sec-verification">
            <div class="section-title-bar">
                <h1>Verification</h1>
                <span class="section-badge">Gate</span>
            </div>
            <div class="settings-grid cols-2">
                <div class="setting-card">
                    <div class="setting-header">
                        <span class="setting-icon">VR</span>
                        <div>
                            <h3>Verification Gate</h3>
                            <p>Require new members to verify</p>
                        </div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" data-key="verification_enabled" id="toggle_verification">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="input-group">
                    <label>Verification Channel</label>
                    <select data-key="verification_channel" class="input-field log-select"></select>
                </div>
                <div class="input-group">
                    <label>Verified Role</label>
                    <select data-key="verification_role" class="input-field role-select"></select>
                </div>
            </div>
        </section>

        <!-- Save Bar -->
        <div class="save-bar glass" id="saveBar">
            <span>You have unsaved changes</span>
            <div class="save-actions">
                <button class="btn btn-ghost" onclick="resetChanges()">Reset</button>
                <button class="btn btn-primary btn-glow" onclick="saveAll()">Save Changes</button>
            </div>
        </div>
    </main>

    <!-- Filter Settings Modal -->
    <div class="modal-overlay" id="filterModal">
        <div class="modal glass">
            <div class="modal-header">
                <h2 id="modalTitle">Filter Settings</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-ghost" id="modalCancelButton" onclick="closeModal()">Cancel</button>
                <a class="btn btn-ghost modal-more-info" id="modalMoreInfo" href="https://appeal.gg"
                    target="_blank" rel="noopener noreferrer">More info</a>
                <button class="btn btn-primary" id="modalSaveButton" onclick="saveModal()">Save</button>
            </div>
        </div>
    </div>

    <script>
        const GUILD_ID = "{{guild_id}}";
        let currentSettings = {};
        let originalSettings = {};
        let roles = [];
        let channels = [];
        let hasChanges = false;

        //  Filter definitions 
        const FILTERS = [
            {
                key: "automod_enabled", name: "AutoMod Master", icon: "AM", desc: "Master toggle for all AutoMod", color: "#5865F2",
                settings: []
            },
            {
                key: "automod_links_enabled", name: "Link Filter", icon: "LN", desc: "Block unauthorized links", color: "#3ba55d",
                settings: [
                    { key: "automod_links_whitelist", label: "Whitelisted Domains", type: "list" }
                ]
            },
            {
                key: "automod_invites_enabled", name: "Invite Filter", icon: "IV", desc: "Block Discord invite links", color: "#faa61a",
                settings: [
                    { key: "automod_allowed_invites", label: "Allowed Server Invites", type: "list" }
                ]
            },
            { key: "automod_scam_protection", name: "Scam Protection", icon: "SC", desc: "Detect scam & phishing links", color: "#ed4245" },
            {
                key: "automod_ai_enabled", name: "AI Moderation", icon: "AI", desc: "Groq-powered content analysis", color: "#9b59b6",
                settings: [
                    { key: "automod_ai_min_severity", label: "Min Severity (1-10)", type: "number", min: 1, max: 10 }
                ]
            },
            { key: "automod_notify_users", name: "Notify Users", icon: "NT", desc: "DM users when actioned", color: "#3498db" },
            {
                key: "spam", name: "Spam Filter", icon: "SP", desc: "Rate-limit message spam", color: "#e67e22", isGroup: true,
                settings: [
                    { key: "automod_spam_threshold", label: "Msgs per 5s (0=off)", type: "number", min: 0, max: 50 },
                    { key: "automod_duplicate_threshold", label: "Duplicate threshold", type: "number", min: 0, max: 20 }
                ]
            },
            {
                key: "caps", name: "Caps Filter", icon: "CP", desc: "Block excessive CAPS", color: "#e74c3c", isGroup: true,
                settings: [
                    { key: "automod_caps_percentage", label: "Caps % (0-100)", type: "number", min: 0, max: 100 },
                    { key: "automod_caps_min_length", label: "Min msg length", type: "number", min: 1, max: 100 }
                ]
            },
            {
                key: "mentions", name: "Mention Spam", icon: "MN", desc: "Limit mass mentions", color: "#1abc9c", isGroup: true,
                settings: [
                    { key: "automod_max_mentions", label: "Max mentions (0=off)", type: "number", min: 0, max: 50 }
                ]
            },
            {
                key: "newaccount", name: "New Accounts", icon: "NA", desc: "Flag recently-created accounts", color: "#95a5a6", isGroup: true,
                settings: [
                    { key: "automod_newaccount_days", label: "Days threshold", type: "number", min: 0, max: 365 }
                ]
            },
            {
                key: "punishment", name: "Punishment", icon: "PN", desc: "Default AutoMod action", color: "#e91e63", isGroup: true,
                settings: [
                    {
                        key: "automod_punishment", label: "Action", type: "select",
                        options: [
                            { value: "warn", label: "Warn" },
                            { value: "delete", label: "Delete" },
                            { value: "mute", label: "Mute" },
                            { value: "kick", label: "Kick" },
                            { value: "ban", label: "Ban" },
                            { value: "quarantine", label: "Quarantine" }
                        ]
                    },
                    { key: "automod_mute_duration", label: "Mute duration (secs)", type: "number", min: 60, max: 604800 },
                    { key: "automod_tempban_duration", label: "Tempban duration (secs)", type: "number", min: 3600, max: 2592000 }
                ]
            }
        ];

        let currentModalFilter = null;

        function toggleSidebar() {
            if (window.innerWidth <= 1024) {
                document.body.classList.toggle('sidebar-open');
                return;
            }
            document.body.classList.toggle('sidebar-collapsed');
        }

        function applySectionStagger(sectionEl) {
            if (!sectionEl) return;
            const cards = sectionEl.querySelectorAll(
                '.panel, .mod-feature-card, .feature-row, .stat-card, .log-card, .role-card, .setting-card, .filter-card'
            );
            cards.forEach((card, idx) => {
                card.style.setProperty('--stagger-index', String(idx));
            });
        }

        function resetModalFooter() {
            const saveButton = document.getElementById('modalSaveButton');
            const moreInfo = document.getElementById('modalMoreInfo');
            if (!saveButton || !moreInfo) return;
            moreInfo.style.display = 'none';
            saveButton.style.display = 'inline-flex';
            saveButton.textContent = 'Save';
            saveButton.onclick = saveModal;
        }

        function openAppealsModal() {
            const modal = document.getElementById('filterModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            const saveButton = document.getElementById('modalSaveButton');
            const moreInfo = document.getElementById('modalMoreInfo');
            if (!modal || !title || !body || !saveButton || !moreInfo) return;

            currentModalFilter = null;
            title.textContent = 'Set up Appeals';
            body.innerHTML = `
                <div class="appeals-copy">
                    <p>Sapphire is fully compatible with appeal.gg and lets users submit punishment appeals from your server invite.</p>
                    <p>Use appeal.gg to create forms, lock them behind punishments, and manage submissions in one moderation workflow.</p>
                    <p class="muted">appeal.gg was made by the creator of Sapphire, Xge.</p>
                </div>
            `;

            moreInfo.href = 'https://appeal.gg';
            moreInfo.style.display = 'inline-flex';
            saveButton.textContent = 'Set up';
            saveButton.onclick = () => closeModal();
            modal.classList.add('visible');
        }

        // Init
        async function init() {
            await loadSettings();
            await loadCases();
            await loadStats();
            await loadActions();
            applySectionStagger(document.querySelector('.content-section.active'));

            const changelogClose = document.querySelector('.changelog-close');
            const changelogCard = document.querySelector('.changelog-card');
            if (changelogClose && changelogCard) {
                changelogClose.addEventListener('click', () => {
                    changelogCard.classList.add('is-hidden');
                });
            }
        }

        async function loadSettings() {
            const res = await fetch(`/api/guild/${GUILD_ID}/settings`);
            const data = await res.json();
            currentSettings = { ...data.settings };
            originalSettings = { ...data.settings };
            roles = data.roles || [];
            channels = data.channels || [];
            applyToDOM();
            buildFilterCards();
        }

        function applyToDOM() {
            // Toggles
            document.querySelectorAll('[type="checkbox"][data-key]').forEach(el => {
                el.checked = !!currentSettings[el.dataset.key];
            });
            // Number / text inputs
            document.querySelectorAll('input[type="number"][data-key], input[type="text"][data-key]').forEach(el => {
                el.value = currentSettings[el.dataset.key] ?? '';
            });
            // Selects (non-dynamic)
            document.querySelectorAll('select[data-key]:not(.log-select):not(.role-select)').forEach(el => {
                const val = currentSettings[el.dataset.key];
                el.value = val != null ? String(val) : '';
            });

            // Populate role selects
            document.querySelectorAll('.role-select').forEach(sel => {
                const key = sel.dataset.key;
                const current = currentSettings[key];
                sel.innerHTML = '<option value="">None</option>';
                roles.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = '@' + r.name;
                    if (String(current) === r.id) opt.selected = true;
                    sel.appendChild(opt);
                });
            });

            // Populate log channel selects
            document.querySelectorAll('.log-select').forEach(sel => {
                const key = sel.dataset.key;
                const current = currentSettings[key];
                sel.innerHTML = '<option value="">None</option>';
                channels.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = '#' + c.name;
                    if (String(current) === c.id) opt.selected = true;
                    sel.appendChild(opt);
                });
            });

            // Lists
            renderTags('badwordTags', currentSettings.automod_badwords || [], 'badwords');
            renderTags('domainTags', currentSettings.automod_whitelisted_domains || [], 'domains');
            document.getElementById('badwordCount').textContent = (currentSettings.automod_badwords || []).length;
            document.getElementById('domainCount').textContent = (currentSettings.automod_whitelisted_domains || []).length;
        }

        //  Filter Cards 
        function buildFilterCards() {
            const grid = document.getElementById('filterGrid');
            grid.innerHTML = '';
            FILTERS.forEach(f => {
                const isEnabled = f.isGroup ? true : !!currentSettings[f.key];
                const hasSettings = f.settings && f.settings.length > 0;
                const card = document.createElement('div');
                card.className = `filter-card ${isEnabled ? 'enabled' : 'disabled'}`;
                card.style.borderColor = isEnabled ? f.color : '';
                card.innerHTML = `
                <div class="filter-card-top">
                    <div class="filter-info">
                        <span class="filter-icon">${f.icon}</span>
                        <div>
                            <h3>${f.name}</h3>
                            <p>${f.desc}</p>
                        </div>
                    </div>
                    ${hasSettings ? `<button class="gear-btn" onclick="openFilterModal('${f.key}')" title="Settings">CFG</button>` : ''}
                </div>
                <div class="filter-card-bottom">
                    ${!f.isGroup ? `
                    <label class="toggle">
                        <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleFilter('${f.key}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>` : `
                    <span class="filter-status">${getFilterStatus(f)}</span>
                    `}
                </div>
            `;
                grid.appendChild(card);
            });
            applySectionStagger(document.getElementById('sec-automod'));
        }

        function getFilterStatus(f) {
            if (f.key === 'spam') return `${currentSettings.automod_spam_threshold || 5} msgs/5s`;
            if (f.key === 'caps') return `${currentSettings.automod_caps_percentage || 70}%`;
            if (f.key === 'mentions') return `max ${currentSettings.automod_max_mentions || 5}`;
            if (f.key === 'newaccount') return `${currentSettings.automod_newaccount_days || 7} days`;
            if (f.key === 'punishment') return (currentSettings.automod_punishment || 'warn').toUpperCase();
            return '';
        }

        function toggleFilter(key, val) {
            currentSettings[key] = val;
            markChanged();
            buildFilterCards();
        }

        //  Filter Modal 
        function openFilterModal(filterKey) {
            const f = FILTERS.find(x => x.key === filterKey);
            if (!f || !f.settings) return;
            currentModalFilter = f;

            resetModalFooter();
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            if (!title || !body) return;
            title.textContent = f.icon + ' ' + f.name + ' Settings';
            body.innerHTML = '';

            f.settings.forEach(s => {
                const group = document.createElement('div');
                group.className = 'input-group';

                if (s.type === 'number') {
                    group.innerHTML = `
                    <label>${s.label}</label>
                    <input type="number" class="input-field modal-input" data-modal-key="${s.key}"
                           min="${s.min || 0}" max="${s.max || 999}"
                           value="${currentSettings[s.key] ?? ''}">
                `;
                } else if (s.type === 'select') {
                    const opts = s.options.map(o =>
                        `<option value="${o.value}" ${currentSettings[s.key] === o.value ? 'selected' : ''}>${o.label}</option>`
                    ).join('');
                    group.innerHTML = `<label>${s.label}</label><select class="input-field modal-input" data-modal-key="${s.key}">${opts}</select>`;
                } else if (s.type === 'list') {
                    const items = currentSettings[s.key] || [];
                    group.innerHTML = `
                    <label>${s.label}</label>
                    <input type="text" class="input-field modal-input" data-modal-key="${s.key}" data-type="list"
                           value="${items.join(', ')}">
                    <span class="hint">Comma-separated</span>
                `;
                }
                body.appendChild(group);
            });

            document.getElementById('filterModal').classList.add('visible');
        }

        function closeModal() {
            const modal = document.getElementById('filterModal');
            if (modal) modal.classList.remove('visible');
            resetModalFooter();
            currentModalFilter = null;
        }

        function saveModal() {
            document.querySelectorAll('.modal-input').forEach(el => {
                const key = el.dataset.modalKey;
                if (el.dataset.type === 'list') {
                    currentSettings[key] = el.value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
                } else if (el.type === 'number') {
                    currentSettings[key] = parseInt(el.value) || 0;
                } else {
                    currentSettings[key] = el.value;
                }
            });
            markChanged();
            closeModal();
            buildFilterCards();
            applyToDOM();
        }

        //  Cases 
        async function loadCases() {
            try {
                const res = await fetch(`/api/guild/${GUILD_ID}/cases?limit=25`);
                const data = await res.json();
                const tbody = document.getElementById('casesBody');
                if (!data.cases || data.cases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-row">No cases found</td></tr>';
                    return;
                }
                tbody.innerHTML = data.cases.map(c => `
                <tr>
                    <td><span class="case-num">#${c.case_number}</span></td>
                    <td><span class="action-badge action-${c.action}">${c.action}</span></td>
                    <td class="mono">${c.user_id}</td>
                    <td class="mono">${c.moderator_id}</td>
                    <td class="reason-cell">${c.reason || 'No reason'}</td>
                    <td class="date-cell">${c.created_at ? new Date(c.created_at).toLocaleDateString() : '-'}</td>
                </tr>
            `).join('');
            } catch (e) { }
        }

        //  Stats 
        async function loadStats() {
            try {
                const res = await fetch(`/api/guild/${GUILD_ID}/stats`);
                const data = await res.json();
                const s = data.stats;
                document.getElementById('statCases').textContent = s.total_cases || 0;
                document.getElementById('statWarnings').textContent = s.total_warnings || 0;
                document.getElementById('statReports').textContent = s.total_reports || 0;
                document.getElementById('statTickets').textContent = s.total_tickets || 0;
            } catch (e) { }
        }

        //  Recent Actions 
        async function loadActions() {
            try {
                const res = await fetch(`/api/guild/${GUILD_ID}/actions`);
                const data = await res.json();
                const tbody = document.getElementById('actionsBody');
                if (!data.actions || data.actions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="empty-row">No actions yet</td></tr>';
                    return;
                }
                tbody.innerHTML = data.actions.slice(0, 10).map(a => `
                <tr><td>${a.time}</td><td>${a.user}</td><td>${a.action}</td></tr>
            `).join('');
            } catch (e) { }
        }

        //  Section Switching 
        function switchSection(name) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const section = document.getElementById('sec-' + name);
            const navItem = document.querySelector(`[data-section="${name}"]`);
            if (!section || !navItem) return;

            section.classList.add('active');
            navItem.classList.add('active');
            applySectionStagger(section);

            if (window.innerWidth <= 1024) {
                document.body.classList.remove('sidebar-open');
            }
        }

        //  Tags 
        function renderTags(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.innerHTML = `${item} <button onclick="removeFromList('${type}', '${item}')">&times;</button>`;
                container.appendChild(tag);
            });
        }

        function addToList(type) {
            const inputId = type === 'badwords' ? 'badwordInput' : 'domainInput';
            const key = type === 'badwords' ? 'automod_badwords' : 'automod_whitelisted_domains';
            const input = document.getElementById(inputId);
            const items = input.value.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
            if (!currentSettings[key]) currentSettings[key] = [];
            items.forEach(item => {
                if (!currentSettings[key].includes(item)) currentSettings[key].push(item);
            });
            input.value = '';
            markChanged();
            applyToDOM();
        }

        function removeFromList(type, item) {
            const key = type === 'badwords' ? 'automod_badwords' : 'automod_whitelisted_domains';
            currentSettings[key] = (currentSettings[key] || []).filter(x => x !== item);
            markChanged();
            applyToDOM();
        }

        //  Change Tracking 
        function markChanged() {
            hasChanges = true;
            document.getElementById('saveBar').classList.add('visible');
        }

        function resetChanges() {
            currentSettings = { ...originalSettings };
            hasChanges = false;
            document.getElementById('saveBar').classList.remove('visible');
            applyToDOM();
            buildFilterCards();
        }

        // Event listeners for all inputs
        document.addEventListener('change', e => {
            const key = e.target.dataset?.key;
            if (!key) return;
            if (e.target.type === 'checkbox') {
                currentSettings[key] = e.target.checked;
            } else if (e.target.type === 'number') {
                currentSettings[key] = parseInt(e.target.value) || 0;
            } else if (e.target.tagName === 'SELECT') {
                const val = e.target.value;
                if (key.endsWith('_id') || key.startsWith('log_channel') || key.endsWith('_channel') || key.endsWith('_role')) {
                    currentSettings[key] = val ? parseInt(val) : null;
                } else {
                    currentSettings[key] = val;
                }
            } else {
                currentSettings[key] = e.target.value;
            }
            markChanged();
        });

        document.addEventListener('input', e => {
            const key = e.target.dataset?.key;
            if (key && (e.target.type === 'number' || e.target.type === 'text')) {
                currentSettings[key] = e.target.type === 'number' ? (parseInt(e.target.value) || 0) : e.target.value;
                markChanged();
            }
        });

        //  Save 
        async function saveAll() {
            const btn = document.querySelector('#saveBar .btn-primary');
            btn.textContent = 'Saving...';
            btn.disabled = true;
            try {
                const res = await fetch(`/api/guild/${GUILD_ID}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: currentSettings }),
                });
                const data = await res.json();
                if (data.ok) {
                    originalSettings = { ...data.settings };
                    currentSettings = { ...data.settings };
                    hasChanges = false;
                    document.getElementById('saveBar').classList.remove('visible');
                    showToast('Settings saved successfully!', 'success');
                    await loadActions();
                } else {
                    showToast('Failed: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
            btn.textContent = 'Save Changes';
            btn.disabled = false;
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = (type === 'success' ? 'Success: ' : 'Error: ') + msg;
            toast.className = 'toast visible ' + type;
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        init();
    </script>
</body>

</html>




